---
doc_type: "adr"
id: "0001"
title: "JWT認証方式の採用"
status: "accepted"
date: "2026-01-18"
deciders: ["Architecture Team"]
---

# ADR-001: JWT認証方式の採用

## ステータス

Accepted

## コンテキスト

本システムは複数のBounded Context（IAM, Booking, Payment等）で構成されるマイクロサービスアーキテクチャを採用する予定である。各サービス間で認証情報を共有し、ユーザーのリクエストを認可する仕組みが必要となる。

### 検討すべき要件

1. **ステートレス性**: 各サービスが独立してスケール可能
2. **パフォーマンス**: 認証処理のレイテンシを最小化
3. **セキュリティ**: トークン漏洩時のリスク軽減
4. **運用性**: 鍵管理、ローテーションの容易さ
5. **標準準拠**: 業界標準のプロトコルに従う

## 決定

**JWT（JSON Web Token）をAPI認証の主要方式として採用する。**

### 採用する構成

| 項目 | 決定事項 |
|------|----------|
| トークン形式 | JWT (RFC 7519) |
| 署名アルゴリズム | RS256（RSA + SHA-256） |
| AccessToken有効期限 | 15分 |
| RefreshToken有効期限 | 7日（Remember Me: 30日） |
| 鍵管理 | 非対称鍵（IAMサービスのみ秘密鍵保持） |

### トークン構造

```json
// Header
{
  "alg": "RS256",
  "typ": "JWT",
  "kid": "key-2026-01"
}

// Payload
{
  "iss": "https://api.example.com",
  "sub": "<user-id>",
  "aud": "booking-payment-api",
  "iat": <issued-at>,
  "exp": <expiration>,
  "jti": "<token-id>",
  "type": "access",
  "roles": ["user"]
}
```

## 検討した選択肢

### 選択肢1: セッションベース認証（不採用）

```
┌────────┐      ┌─────────┐      ┌──────────────┐
│ Client │─────>│ Service │─────>│ Session Store│
└────────┘      └─────────┘      │  (Redis等)   │
                                 └──────────────┘
```

**メリット:**
- 即時無効化が可能
- トークンサイズが小さい

**デメリット:**
- 中央集権的なセッションストアが必要（SPOF）
- 各リクエストでセッションストアへのアクセスが発生
- サービス間でセッション共有の複雑さ

### 選択肢2: JWT + HS256（対称鍵）（不採用）

**メリット:**
- 署名・検証が高速
- 実装がシンプル

**デメリット:**
- 秘密鍵を全サービスで共有する必要がある
- 1つのサービスが侵害されると全体が危険
- 鍵ローテーションが困難

### 選択肢3: JWT + RS256（非対称鍵）（採用）

```
┌────────┐      ┌─────────┐
│ Client │─────>│   IAM   │ ← 秘密鍵で署名
└────────┘      └─────────┘
    │
    │ JWT
    ▼
┌─────────┐     ┌─────────┐
│ Booking │     │ Payment │ ← 公開鍵で検証
└─────────┘     └─────────┘
```

**メリット:**
- IAMサービスのみが秘密鍵を保持
- 他サービスは公開鍵のみで検証可能
- JWKSエンドポイントで鍵配布が容易
- 鍵ローテーションが安全に実行可能

**デメリット:**
- HS256より検証処理がやや遅い（許容範囲）
- 鍵ペア管理の運用コスト

### 選択肢4: OAuth 2.0 / OIDC（部分採用）

**メリット:**
- 標準化されたフロー
- 外部IdP統合が容易

**デメリット:**
- 自前IdPとしては過剰な複雑さ
- 学習コストが高い

**結論:** JWTの署名・検証部分でOAuth 2.0/OIDCの仕様を参考にしつつ、フルスタックのOIDC実装は見送る。

## 結果

### 正の影響

1. **ステートレス認証**: 各サービスがDBアクセスなしで認証可能
2. **スケーラビリティ**: サービス追加時も公開鍵配布のみ
3. **セキュリティ分離**: 秘密鍵がIAMサービスに限定
4. **標準準拠**: JWT/JWKSの広範なライブラリサポート

### 負の影響

1. **即時無効化の制限**: AccessToken有効期間中は無効化不可
   - **緩和策**: 短い有効期限（15分）+ RefreshTokenローテーション
2. **トークンサイズ**: セッションIDより大きい
   - **緩和策**: 必要最小限のクレームに限定
3. **鍵管理の運用負荷**
   - **緩和策**: JWKS自動ローテーションの仕組みを構築

### 関連決定

- ADR-002: RefreshTokenローテーション戦略
- ADR-003: Brute-force対策の閾値設定

## 参考資料

- RFC 7519: JSON Web Token (JWT)
- RFC 7517: JSON Web Key (JWK)
- RFC 7518: JSON Web Algorithms (JWA)
- OAuth 2.0 Security Best Current Practice
- OWASP Authentication Cheat Sheet
